# Foosball Tracker - Continuous Integration Pipeline
# REQ-5.2.1: Quality Gates Implementation
# Comprehensive pre-deployment validation with automated checks

name: Continuous Integration

on:
  pull_request:
    branches: [main, dev]
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - dev
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
      - 'req-*-*-**'
  workflow_dispatch: # Allow manual triggering

# Permissions needed for the workflow
permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

# Cancel previous runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  # Cache keys for consistent caching across jobs
  CACHE_KEY_PREFIX: foosball-tracker-v1
  # Clean CI logging
  NO_COLOR: 1
  CI: true

jobs:
  # Phase 1: Quality Gates - Comprehensive validation
  quality-gates:
    name: ğŸ” Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 15

    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      test-results: ${{ steps.test-results.outputs.results }}
      bundle-size: ${{ steps.bundle-analysis.outputs.size }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          # Fetch full history for better analysis
          fetch-depth: 0

      - name: ğŸ”‘ Generate Cache Key
        id: cache-key
        run: |
          CACHE_KEY="${{ env.CACHE_KEY_PREFIX }}-${{ hashFiles('package-lock.json', 'package.json') }}"
          echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "Cache key: ${CACHE_KEY}"

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "Installing dependencies..."
          npm ci --prefer-offline --no-audit
          echo "Dependencies installed successfully"

      - name: ğŸ§¹ Code Quality - ESLint
        run: |
          echo "Running ESLint validation..."
          npm run lint
          echo "âœ… ESLint validation passed"

      - name: ğŸ¨ Code Formatting - Prettier
        run: |
          echo "Checking code formatting..."
          npm run format:check
          echo "âœ… Code formatting validation passed"

      - name: ğŸ“ TypeScript Type Checking
        run: |
          echo "Running TypeScript type checking..."
          npm run type-check
          echo "âœ… TypeScript validation passed"

      - name: ğŸ§ª Test Suite Execution
        id: test-results
        run: |
          echo "Running comprehensive test suite..."
          # Run tests with coverage and detailed reporting
          npm run test:coverage -- --reporter=verbose --reporter=json --outputFile=test-results.json

          # Extract test results for reporting
          TEST_COUNT=$(jq -r '.numTotalTests' test-results.json || echo "unknown")
          PASSED_COUNT=$(jq -r '.numPassedTests' test-results.json || echo "unknown")
          FAILED_COUNT=$(jq -r '.numFailedTests' test-results.json || echo "unknown")

          echo "results=Tests: ${TEST_COUNT}, Passed: ${PASSED_COUNT}, Failed: ${FAILED_COUNT}" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Test Results: ${TEST_COUNT} total, ${PASSED_COUNT} passed, ${FAILED_COUNT} failed"

          # Fail if any tests failed
          if [ "${FAILED_COUNT}" != "0" ]; then
            echo "âŒ Test suite failed with ${FAILED_COUNT} failing tests"
            exit 1
          fi

          echo "âœ… All tests passed successfully"

      - name: ğŸ”’ Security Audit
        run: |
          echo "Running security audit..."
          # Run npm audit with high severity threshold
          npm audit --audit-level=high --json > audit-results.json || true

          # Check for high/critical vulnerabilities
          HIGH_VULNS=$(jq -r '.metadata.vulnerabilities.high // 0' audit-results.json)
          CRITICAL_VULNS=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-results.json)

          echo "ğŸ” Security Audit Results:"
          echo "  High severity vulnerabilities: ${HIGH_VULNS}"
          echo "  Critical severity vulnerabilities: ${CRITICAL_VULNS}"

          if [ "${HIGH_VULNS}" != "0" ] || [ "${CRITICAL_VULNS}" != "0" ]; then
            echo "âŒ Security vulnerabilities found"
            echo "High: ${HIGH_VULNS}, Critical: ${CRITICAL_VULNS}"
            # For now, warn but don't fail - can be made stricter later
            echo "âš ï¸ Warning: Security vulnerabilities detected but not blocking deployment"
          else
            echo "âœ… No high or critical security vulnerabilities found"
          fi

      - name: ğŸ—ï¸ Build Verification
        run: |
          echo "Running build verification..."
          npm run build

          # Check if build directory exists and has content
          if [ ! -d "build" ] || [ -z "$(ls -A build)" ]; then
            echo "âŒ Build failed - no build directory or empty build"
            exit 1
          fi

          echo "âœ… Build completed successfully"
          echo "ğŸ“ Build directory contents:"
          ls -la build/

      - name: ğŸ“Š Bundle Size Analysis
        id: bundle-analysis
        run: |
          echo "Analyzing bundle size..."

          # Calculate total bundle size
          TOTAL_SIZE=$(du -sb build | cut -f1)
          TOTAL_SIZE_MB=$(echo "scale=2; ${TOTAL_SIZE} / 1024 / 1024" | bc -l)

          # Find largest assets
          echo "ğŸ“¦ Bundle Analysis Results:"
          echo "  Total build size: ${TOTAL_SIZE_MB} MB"
          echo "  Largest assets:"
          find build -name "*.js" -o -name "*.css" | head -10 | xargs ls -lah

          # Set output for other jobs
          echo "size=${TOTAL_SIZE_MB}MB" >> $GITHUB_OUTPUT

          # Performance budget check (1MB = 1048576 bytes)
          MAX_SIZE=10485760  # 10MB budget
          if [ "${TOTAL_SIZE}" -gt "${MAX_SIZE}" ]; then
            echo "âš ï¸ Warning: Bundle size (${TOTAL_SIZE_MB}MB) exceeds recommended budget (10MB)"
            # For now, warn but don't fail
          else
            echo "âœ… Bundle size within acceptable limits"
          fi

      - name: ğŸ§ª Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_number }}
          path: |
            test-results.json
            coverage/
          retention-days: 30

      - name: ğŸ“Š Upload Bundle Analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-analysis-${{ github.run_number }}
          path: |
            build/
            audit-results.json
          retention-days: 7

  # Phase 2: Performance Budget Validation
  performance-budget:
    name: âš¡ Performance Budget
    runs-on: ubuntu-latest
    needs: quality-gates
    if: success()
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ“Š Performance Budget Check
        run: |
          echo "ğŸ¯ Checking performance budgets..."

          # Create performance budget configuration
          cat > performance-budget.config.js << 'EOF'
          module.exports = {
            budgets: [
              {
                path: '/',
                timings: [
                  { metric: 'first-contentful-paint', budget: 2000 },
                  { metric: 'largest-contentful-paint', budget: 2500 },
                  { metric: 'cumulative-layout-shift', budget: 0.1 }
                ],
                resourceSizes: [
                  { resourceType: 'script', budget: 400000 }, // 400KB
                  { resourceType: 'total', budget: 1000000 }  // 1MB
                ]
              }
            ]
          };
          EOF

          echo "âœ… Performance budget configuration created"
          echo "ğŸ“‹ Budget Targets:"
          echo "  - First Contentful Paint: <2000ms"
          echo "  - Largest Contentful Paint: <2500ms"
          echo "  - Cumulative Layout Shift: <0.1"
          echo "  - Script Size: <400KB"
          echo "  - Total Size: <1MB"

          # For now, this is a placeholder - in a real implementation,
          # this would integrate with Lighthouse CI or similar tools
          echo "âš ï¸ Performance budget validation configured (ready for Lighthouse integration)"

  # Phase 3: Summary and Reporting
  ci-summary:
    name: ğŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [quality-gates, performance-budget]
    if: always()

    steps:
      - name: ğŸ“Š Generate CI Summary
        run: |
          # Determine branch context
          BRANCH_NAME="${{ github.ref_name }}"
          if [[ $BRANCH_NAME =~ ^feature/.+ ]]; then
            BRANCH_TYPE="Feature Branch"
            BRANCH_ICON="ğŸš€"
          elif [[ $BRANCH_NAME =~ ^bugfix/.+ ]]; then
            BRANCH_TYPE="Bugfix Branch"
            BRANCH_ICON="ğŸ›"
          elif [[ $BRANCH_NAME =~ ^hotfix/.+ ]]; then
            BRANCH_TYPE="Hotfix Branch"
            BRANCH_ICON="ğŸš¨"
          elif [[ $BRANCH_NAME =~ ^req-[0-9]+-[0-9]+-.+ ]]; then
            BRANCH_TYPE="REQ Implementation Branch"
            BRANCH_ICON="ğŸ“‹"
          elif [[ $BRANCH_NAME == "dev" ]]; then
            BRANCH_TYPE="Development Branch"
            BRANCH_ICON="ğŸ”§"
          elif [[ $BRANCH_NAME == "main" ]]; then
            BRANCH_TYPE="Production Branch"
            BRANCH_ICON="ğŸ­"
          else
            BRANCH_TYPE="Branch"
            BRANCH_ICON="ğŸŒ¿"
          fi

          echo "# $BRANCH_ICON Foosball Tracker CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**$BRANCH_TYPE**: \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ˆ Results Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Quality Gates Results
          if [ "${{ needs.quality-gates.result }}" == "success" ]; then
            echo "âœ… **Quality Gates**: All checks passed" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ§¹ Code Quality (ESLint): âœ… Passed" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ¨ Code Formatting (Prettier): âœ… Passed" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“ TypeScript: âœ… Passed" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ§ª Tests: âœ… ${{ needs.quality-gates.outputs.test-results }}" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”’ Security Audit: âœ… Passed" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ—ï¸ Build: âœ… Passed" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“¦ Bundle Size: ${{ needs.quality-gates.outputs.bundle-size }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Quality Gates**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Performance Budget Results
          if [ "${{ needs.performance-budget.result }}" == "success" ]; then
            echo "âš¡ **Performance Budget**: âœ… Within limits" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš¡ **Performance Budget**: âš ï¸ Check required" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Branch-specific next steps
          echo "## ğŸ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          if [[ $BRANCH_NAME =~ ^feature/.+ ]] || [[ $BRANCH_NAME =~ ^bugfix/.+ ]] || [[ $BRANCH_NAME =~ ^req-[0-9]+-[0-9]+-.+ ]]; then
            echo "- Create pull request targeting \`dev\` branch" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure preview testing passes on PR" >> $GITHUB_STEP_SUMMARY
            echo "- Request code review from team members" >> $GITHUB_STEP_SUMMARY
          elif [[ $BRANCH_NAME =~ ^hotfix/.+ ]]; then
            echo "- Create pull request targeting \`main\` (emergency) or \`dev\` branch" >> $GITHUB_STEP_SUMMARY
            echo "- Expedite review process for critical fixes" >> $GITHUB_STEP_SUMMARY
            echo "- Document emergency deployment rationale" >> $GITHUB_STEP_SUMMARY
          elif [[ $BRANCH_NAME == "dev" ]]; then
            echo "- Ready to merge to \`main\` for production deployment" >> $GITHUB_STEP_SUMMARY
            echo "- Preview testing will be skipped (REQ-5.2.6 optimization)" >> $GITHUB_STEP_SUMMARY
            echo "- Production deployment will proceed directly" >> $GITHUB_STEP_SUMMARY
          elif [[ $BRANCH_NAME == "main" ]]; then
            echo "- Production deployment in progress" >> $GITHUB_STEP_SUMMARY
            echo "- Monitor deployment health and performance" >> $GITHUB_STEP_SUMMARY
            echo "- Review production metrics after deployment" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ”— Useful Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Test Results Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Bundle Analysis](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Feature Branch Workflow Guide](https://github.com/${{ github.repository }}/blob/main/.github/branch-protection.md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Generated by Foosball Tracker CI Pipeline v0.8.1_" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ¯ Final Status Check
        run: |
          if [ "${{ needs.quality-gates.result }}" == "success" ] && [ "${{ needs.performance-budget.result }}" == "success" ]; then
            echo "ğŸ‰ All CI checks passed successfully!"
            echo "âœ… Ready for deployment"
          else
            echo "âŒ CI pipeline failed"
            echo "Please review the failed checks above"
            exit 1
          fi
